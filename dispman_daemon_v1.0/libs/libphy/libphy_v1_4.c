/****************************************************************************
Copyright (C) 2013 Telechips Inc.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
****************************************************************************/
#include <stdio.h>
#include <string.h>
#include <utils/Log.h>
#include <fcntl.h>
#include <sys/ioctl.h>

#include "libphy.h"
#include "libiic/libiic.h"


#define PHY_DEBUG   1
#define LOG_TAG				"LIBPHY: "
#if PHY_DEBUG
#define DPRINTF(args...)    ALOGD(args)
#else
#define DPRINTF(args...)
#endif

/**
 * PHY register setting values for each Pixel clock and Bit depth (8, 10, 12 bit).\n
 * @see  Setting values are came from L6LP_HDMI_v1p3_TX_PHY_RegisterMap_REV0.90.doc document.
 */

static const unsigned char phy_config[][3][31] = {// TCC893X HDMI PHY Setting
        //25.200
    {
		{0x05, 0x00, 0xD8, 0x10, 0x1C, 0x30, 0x40, 0x61, 0x10, 0x02, 0x51, 0x5F, 0xF1, 0x51, 0x7F, 0x84, 0x00, 0x10, 0x38, 0x00, 0x08, 0x10, 0xE0, /*0x22, 0x40,*/ 0x00,0x40, 0xF3, 0x26, 0x00, 0x00, 0x00, 0x80},
		{0x05, 0x00, 0xD8, 0x10, 0x1C, 0x30, 0x40, 0x61, 0x10, 0x02, 0x51, 0x9F, 0xF6, 0x51, 0x9E, 0x84, 0x00, 0x32, 0x38, 0x00, 0xB8, 0x10, 0xE0, /*0x22, 0x40,*/ 0x00,0x40, 0xC2, 0x26, 0x00, 0x00, 0x00, 0x80},
		{0x05, 0x00, 0xD8, 0x10, 0x1C, 0x30, 0x40, 0x61, 0x10, 0x02, 0x51, 0xFF, 0xF3, 0x51, 0xBD, 0x84, 0x00, 0x30, 0x38, 0x00, 0xA4, 0x10, 0xE0, /*0x22, 0x40,*/ 0x00,0x40, 0xA2, 0x26, 0x00, 0x00, 0x00, 0x80},

    },
        //25.175
    {
		{0x05, 0x00, 0xD8, 0x10, 0x9C, 0x1E, 0x20, 0x61, 0x50, 0x10, 0x51, 0xFF, 0xF1, 0x51, 0xBD, 0x84, 0x00, 0x10, 0x38, 0x00, 0x08, 0x10, 0xE0, /*0x22, 0x40,*/ 0x00,0x40, 0xF3, 0x26, 0x00, 0x00, 0x00, 0x80},
		{0x05, 0x00, 0xD8, 0x10, 0x9C, 0x2B, 0x40, 0x61, 0x50, 0x10, 0x51, 0x7F, 0xF2, 0x51, 0xEC, 0x84, 0x00, 0x10, 0x38, 0x00, 0xB8, 0x10, 0xE0, /*0x22, 0x40,*/ 0x00,0x40, 0xC2, 0x26, 0x00, 0x00, 0x00, 0x80},
		{0x05, 0x00, 0xD8, 0x10, 0x9C, 0x1E, 0x20, 0x61, 0x10, 0x02, 0x51, 0xFF, 0xF1, 0x51, 0xBD, 0x84, 0x00, 0x10, 0x38, 0x00, 0xA4, 0x10, 0xE0, /*0x22, 0x40,*/ 0x00,0x40, 0xA2, 0x26, 0x00, 0x00, 0x00, 0x80},

    },
        //27.000
    {
		{0x05, 0x00, 0x10, 0x10, 0x9C, 0x01, 0xDB, 0x61, 0x10, 0x02, 0x51, 0xDF, 0xF2, 0x51, 0x87, 0x84, 0x00, 0x30, 0x38, 0x00, 0x08, 0x10, 0xE0, /*0x22, 0x40,*/ 0x00,0x40, 0xE3, 0x26, 0x00, 0x00, 0x00, 0x80},
		{0x05, 0x00, 0xD8, 0x10, 0x9E, 0x2D, 0xDB, 0x61, 0x10, 0x02, 0x51, 0xEF, 0xF1, 0x51, 0xA9, 0x84, 0x00, 0x10, 0x38, 0x00, 0xB8, 0x10, 0xE0, /*0x22, 0x40,*/ 0x00,0x40, 0xB5, 0x26, 0x00, 0x00, 0x00, 0x80},
		{0x05, 0x00, 0xD8, 0x10, 0x9E, 0xD2, 0x5B, 0x61, 0x10, 0x02, 0x51, 0x2F, 0xF2, 0x51, 0xCB, 0x84, 0x00, 0x10, 0x38, 0x00, 0xA4, 0x10, 0xE0, /*0x22, 0x40,*/ 0x00,0x40, 0x97, 0x26, 0x00, 0x00, 0x00, 0x80},
    },
        //27.027
    {
		{0x05, 0x00, 0xD4, 0x10, 0x9C, 0x09, 0x64, 0x61, 0x10, 0x02, 0x51, 0xDF, 0xF2, 0x51, 0x87, 0x84, 0x00, 0x30, 0x38, 0x00, 0x08, 0x10, 0xE0, /*0x22, 0x40,*/ 0x00,0x40, 0xE2, 0x26, 0x00, 0x00, 0x00, 0x80},
		{0x05, 0x00, 0xD4, 0x10, 0x9C, 0x31, 0x50, 0x61, 0x10, 0x02, 0x51, 0x8F, 0xF3, 0x51, 0xA9, 0x84, 0x00, 0x30, 0x38, 0x00, 0xB8, 0x10, 0xE0, /*0x22, 0x40,*/ 0x00,0x40, 0xB5, 0x26, 0x00, 0x00, 0x00, 0x80},
		{0x05, 0x00, 0x10, 0x10, 0x9C, 0x1B, 0x64, 0x61, 0x10, 0x02, 0x51, 0x7F, 0xF8, 0x51, 0xCB, 0x84, 0x00, 0x32, 0x38, 0x00, 0xA4, 0x10, 0xE0, /*0x22, 0x40,*/ 0x00,0x40, 0x97, 0x26, 0x00, 0x00, 0x00, 0x80},
    },
        //54.000
    {
		{0x05, 0x00, 0x10, 0x10, 0x9C, 0x01, 0xDB, 0x61, 0x10, 0x01, 0x51, 0xDF, 0xF2, 0x51, 0x87, 0x84, 0x00, 0x30, 0x38, 0x00, 0x08, 0x10, 0xE0, /*0x22, 0x40,*/ 0x00,0x40, 0xE3, 0x26, 0x01, 0x00, 0x00, 0x80},
		{0x05, 0x00, 0xD8, 0x10, 0x9C, 0x2D, 0xDB, 0x61, 0x10, 0x01, 0x51, 0xCF, 0xF1, 0x51, 0xA9, 0x84, 0x00, 0x10, 0x38, 0x00, 0xF8, 0x10, 0xE0, /*0x22, 0x40,*/ 0x00,0x40, 0xB5, 0x26, 0x01, 0x00, 0x00, 0x80},
		{0x05, 0x00, 0xD8, 0x10, 0x9C, 0xD2, 0x5B, 0x61, 0x10, 0x01, 0x51, 0x2F, 0xF2, 0x51, 0xCB, 0x84, 0x00, 0x10, 0x38, 0x00, 0xE4, 0x10, 0xE0, /*0x22, 0x40,*/ 0x00,0x40, 0x97, 0x26, 0x01, 0x00, 0x00, 0x80},
    },
        //54.054
    {
		{0x05, 0x00, 0xD4, 0x10, 0x9C, 0x09, 0x64, 0x61, 0x10, 0x01, 0x51, 0xDF, 0xF2, 0x51, 0x87, 0x84, 0x00, 0x30, 0x38, 0x00, 0x08, 0x10, 0xE0, /*0x22, 0x40,*/ 0x00,0x40, 0xE2, 0x26, 0x01, 0x00, 0x00, 0x80},
		{0x05, 0x00, 0xD4, 0x10, 0x9C, 0x31, 0x50, 0x61, 0x10, 0x01, 0x51, 0x8F, 0xF3, 0x51, 0xA9, 0x84, 0x00, 0x30, 0x38, 0x00, 0xF8, 0x10, 0xE0, /*0x22, 0x40,*/ 0x00,0x40, 0xB5, 0x26, 0x01, 0x00, 0x00, 0x80},
		{0x05, 0x00, 0x10, 0x10, 0x9C, 0x1B, 0x64, 0x61, 0x10, 0x01, 0x51, 0x7F, 0xF8, 0x51, 0xCB, 0x84, 0x00, 0x32, 0x38, 0x00, 0xE4, 0x10, 0xE0, /*0x22, 0x40,*/ 0x00,0x40, 0x97, 0x26, 0x01, 0x00, 0x00, 0x80},
    },
        //74.250
    {
		{0x05, 0x00, 0xD8, 0x10, 0x9C, 0xE9, 0xDC, 0x61, 0x10, 0x01, 0x51, 0xFF, 0xF1, 0x51, 0xBA, 0x84, 0x00, 0x10, 0x38, 0x00, 0x08, 0x10, 0xE0, /*0x22, 0x40,*/ 0x00,0x40, 0xA4, 0x26, 0x01, 0x00, 0x00, 0x80},
		{0x05, 0x00, 0xD8, 0x10, 0x9C, 0x37, 0xD0, 0x61, 0x10, 0x01, 0x51, 0xDF, 0xF4, 0x51, 0xE8, 0x84, 0x00, 0x30, 0x38, 0x00, 0xF8, 0x10, 0xE0, /*0x22, 0x40,*/ 0x00,0x40, 0x83, 0x26, 0x01, 0x00, 0x00, 0x80},
		{0x05, 0x00, 0xD8, 0x10, 0x9C, 0xE2, 0xD0, 0x61, 0x10, 0x01, 0x51, 0xDF, 0xF5, 0x51, 0x16, 0x85, 0x00, 0x30, 0x38, 0x00, 0xE4, 0x10, 0xE0, /*0x22, 0x40,*/ 0x00,0x40, 0xDC, 0x26, 0x02, 0x00, 0x00, 0x80},
    },
        //74.176
    {
		{0x05, 0x00, 0xD4, 0x10, 0x9C, 0xBC, 0xDB, 0x61, 0x10, 0x01, 0x51, 0xEF, 0xF3, 0x51, 0xB9, 0x84, 0x00, 0x30, 0x38, 0x00, 0x08, 0x10, 0xE0, /*0x22, 0x40,*/ 0x00,0x40, 0xA5, 0x26, 0x01, 0x00, 0x00, 0x80},
		{0x05, 0x00, 0xD4, 0x10, 0x9C, 0xAB, 0xDB, 0x61, 0x10, 0x01, 0x51, 0xBF, 0xF9, 0x51, 0xE8, 0x84, 0x00, 0x32, 0x38, 0x00, 0xF8, 0x10, 0xE0, /*0x22, 0x40,*/ 0x00,0x40, 0x84, 0x26, 0x01, 0x00, 0x00, 0x80},
		{0x05, 0x00, 0xD8, 0x10, 0x9C, 0xCD, 0xDB, 0x61, 0x10, 0x01, 0x51, 0xDF, 0xF5, 0x51, 0x16, 0x84, 0x00, 0x30, 0x38, 0x00, 0xE4, 0x10, 0xE0, /*0x22, 0x40,*/ 0x00,0x40, 0xDC, 0x26, 0x02, 0x00, 0x00, 0x80},
    },
        //148.500
    {
		{0x05, 0x00, 0xD8, 0x10, 0x9C, 0xE9, 0xDC, 0x61, 0x18, 0x00, 0x51, 0xFF, 0xF1, 0x51, 0xBA, 0x84, 0x00, 0x10, 0x38, 0x00, 0x08, 0x10, 0xE0, /*0x22, 0x40,*/ 0x00,0x40, 0xA4, 0x26, 0x02, 0x00, 0x00, 0x80},
		{0x05, 0x00, 0xD8, 0x10, 0x9C, 0x37, 0xD0, 0x61, 0x18, 0x00, 0x51, 0xDF, 0xF4, 0x51, 0xE8, 0x84, 0x00, 0x30, 0x38, 0x00, 0xF8, 0x10, 0x60, /*0x22, 0x40,*/ 0x08,0x42, 0x83, 0x26, 0x02, 0x00, 0x00, 0x80},
		{0x05, 0x00, 0xD8, 0x10, 0x9C, 0xE2, 0xD0, 0x61, 0x18, 0x00, 0x51, 0xDF, 0xF5, 0x51, 0x16, 0x85, 0x00, 0x30, 0x38, 0x00, 0xE4, 0x10, 0x60, /*0x22, 0x40,*/ 0x08,0x42, 0x6D, 0x26, 0x02, 0x00, 0x00, 0x80},
    },
        //148.352
    {
		{0x05, 0x00, 0xD4, 0x10, 0x9C, 0xBC, 0xDB, 0x61, 0x18, 0x00, 0x51, 0xEF, 0xF3, 0x51, 0xB9, 0x84, 0x00, 0x30, 0x38, 0x00, 0x08, 0x10, 0xE0, /*0x22, 0x40,*/ 0x00,0x40, 0xA5, 0x26, 0x02, 0x00, 0x00, 0x80},
		{0x05, 0x00, 0xD4, 0x10, 0x9C, 0xAB, 0xDB, 0x61, 0x18, 0x00, 0x51, 0xBF, 0xF9, 0x51, 0xE8, 0x84, 0x00, 0x32, 0x38, 0x00, 0xF8, 0x10, 0xE0, /*0x22, 0x40,*/ 0x08,0x42, 0x84, 0x26, 0x02, 0x00, 0x00, 0x80},
		{0x05, 0x00, 0xD8, 0x10, 0x9C, 0xCD, 0xDB, 0x61, 0x18, 0x00, 0x51, 0xDF, 0xF5, 0x51, 0x16, 0x85, 0x00, 0x30, 0x38, 0x00, 0xE4, 0x10, 0xE0, /*0x22, 0x40,*/ 0x08,0x42, 0x6D, 0x26, 0x02, 0x00, 0x00, 0x80},
    },
        //108.108
    {
		{0x05, 0x00, 0xD4, 0x10, 0x9C, 0x09, 0x64, 0x61, 0x18, 0x00, 0x51, 0xDF, 0xF2, 0x51, 0x87, 0x84, 0x00, 0x30, 0x38, 0x00, 0x08, 0x10, 0xE0, /*0x22, 0x40,*/ 0x00,0x40, 0xE2, 0x26, 0x02, 0x00, 0x00, 0x80},
		{0x05, 0x00, 0xD4, 0x10, 0x9C, 0x31, 0x50, 0x61, 0x18, 0x00, 0x51, 0x8F, 0xF3, 0x51, 0xA9, 0x84, 0x00, 0x30, 0x38, 0x00, 0xF8, 0x10, 0xE0, /*0x22, 0x40,*/ 0x00,0x40, 0xB5, 0x26, 0x02, 0x00, 0x00, 0x80},
		{0x05, 0x00, 0x10, 0x10, 0x9C, 0x1B, 0x64, 0x61, 0x18, 0x00, 0x51, 0x7F, 0xF8, 0x51, 0xCB, 0x84, 0x00, 0x32, 0x38, 0x00, 0xE4, 0x10, 0xE0, /*0x22, 0x40,*/ 0x00,0x40, 0x97, 0x26, 0x02, 0x00, 0x00, 0x80},
    },
        //72.000
    {
		{0x05, 0x00, 0xD8, 0x10, 0x1C, 0x30, 0x40, 0x61, 0x10, 0x01, 0x51, 0xEF, 0xF1, 0x51, 0xB4, 0x84, 0x00, 0x10, 0x38, 0x00, 0x08, 0x10, 0xE0, /*0x22, 0x40,*/ 0x00,0x40, 0xAA, 0x26, 0x01, 0x00, 0x00, 0x80},
		{0x05, 0x00, 0xD8, 0x10, 0x1C, 0x30, 0x40, 0x61, 0x10, 0x01, 0x51, 0xBF, 0xF4, 0x51, 0xE1, 0x84, 0x00, 0x30, 0x38, 0x00, 0xF8, 0x10, 0xE0, /*0x22, 0x40,*/ 0x00,0x40, 0x88, 0x26, 0x01, 0x00, 0x00, 0x80},
		{0x05, 0x00, 0xD8, 0x10, 0x1C, 0x30, 0x40, 0x61, 0x18, 0x00, 0x51, 0xDF, 0xF2, 0x51, 0x87, 0x84, 0x00, 0x30, 0x38, 0x00, 0xE4, 0x10, 0xE0, /*0x22, 0x40,*/ 0x00,0x40, 0xE3, 0x26, 0x02, 0x00, 0x00, 0x80},
    },
        //25.000
    {
		{0x05, 0x00, 0xD8, 0x10, 0x9C, 0x20, 0x40, 0x61, 0x50, 0x10, 0x51, 0xFF, 0xF1, 0x51, 0xBC, 0x84, 0x00, 0x10, 0x38, 0x00, 0x08, 0x10, 0xE0, /*0x22, 0x40,*/ 0x00,0x40, 0xF5, 0x26, 0x00, 0x00, 0x00, 0x80},
		{0x05, 0x00, 0xD8, 0x10, 0x9C, 0x08, 0x40, 0x61, 0x50, 0x10, 0x51, 0x7F, 0xF2, 0x51, 0xEA, 0x84, 0x00, 0x10, 0x38, 0x00, 0xB8, 0x10, 0xE0, /*0x22, 0x40,*/ 0x00,0x40, 0xC4, 0x26, 0x00, 0x00, 0x00, 0x80},
		{0x05, 0x00, 0xD8, 0x10, 0x9C, 0x20, 0x40, 0x61, 0x10, 0x02, 0x51, 0xFF, 0xF1, 0x51, 0xBC, 0x84, 0x00, 0x10, 0x38, 0x00, 0xA4, 0x10, 0xE0, /*0x22, 0x40,*/ 0x00,0x40, 0xA3, 0x26, 0x00, 0x00, 0x00, 0x80},
    },
        //65.000
    {
		{0x05, 0x00, 0xD8, 0x10, 0x9C, 0x02, 0x0C, 0x61, 0x10, 0x01, 0x51, 0xBF, 0xF1, 0x51, 0xA3, 0x84, 0x00, 0x10, 0x38, 0x00, 0x08, 0x10, 0xE0, /*0x22, 0x40,*/ 0x00,0x40, 0xBC, 0x26, 0x01, 0x00, 0x00, 0x80},
		{0x05, 0x00, 0xD8, 0x10, 0x9C, 0xF2, 0x30, 0x61, 0x10, 0x01, 0x51, 0x1F, 0xF2, 0x51, 0xCB, 0x84, 0x00, 0x10, 0x38, 0x00, 0xF8, 0x10, 0xE0, /*0x22, 0x40,*/ 0x00,0x40, 0x96, 0x26, 0x01, 0x00, 0x00, 0x80},
		{0x05, 0x00, 0xD8, 0x10, 0x9C, 0xD0, 0x40, 0x61, 0x10, 0x01, 0x51, 0x9F, 0xF2, 0x51, 0xF4, 0x84, 0x00, 0x10, 0x38, 0x00, 0xE4, 0x10, 0xE0, /*0x22, 0x40,*/ 0x00,0x40, 0x7D, 0x26, 0x01, 0x00, 0x00, 0x80},
    },
        //108.000
    {
		{0x05, 0x00, 0xD8, 0x10, 0x1C, 0x30, 0x40, 0x61, 0x18, 0x00, 0x51, 0xDF, 0xF2, 0x51, 0x87, 0x84, 0x00, 0x30, 0x38, 0x00, 0x08, 0x10, 0xE0, /*0x22, 0x40,*/ 0x00,0x40, 0xE3, 0x26, 0x02, 0x00, 0x00, 0x80},
		{0x05, 0x00, 0xD8, 0x10, 0x9C, 0x02, 0x08, 0x61, 0x18, 0x00, 0x51, 0xCF, 0xF1, 0x51, 0xA9, 0x84, 0x00, 0x10, 0x38, 0x00, 0xF8, 0x10, 0xE0, /*0x22, 0x40,*/ 0x00,0x40, 0xB5, 0x26, 0x02, 0x00, 0x00, 0x80},
		{0x05, 0x00, 0xD8, 0x10, 0x9C, 0xFC, 0x08, 0x61, 0x18, 0x00, 0x51, 0x2F, 0xF2, 0x51, 0xCB, 0x84, 0x00, 0x10, 0x38, 0x00, 0xE4, 0x10, 0xE0, /*0x22, 0x40,*/ 0x00,0x40, 0x97, 0x26, 0x02, 0x00, 0x00, 0x80},
    },
        //162.000
    {
		{0x05, 0x00, 0xD8, 0x10, 0x1C, 0x30, 0x40, 0x61, 0x18, 0x00, 0x51, 0x7F, 0xF8, 0x51, 0xCB, 0x84, 0x00, 0x32, 0x38, 0x00, 0x08, 0x10, 0xE0, /*0x22, 0x40,*/ 0x00,0x40, 0x97, 0x26, 0x02, 0x00, 0x00, 0x80},
		{0x05, 0x00, 0xD8, 0x10, 0x9C, 0x18, 0x40, 0x61, 0x18, 0x00, 0x51, 0xAF, 0xF2, 0x51, 0xFD, 0x84, 0x00, 0x10, 0x38, 0x00, 0xF8, 0x10, 0x60, /*0x22, 0x40,*/ 0x08,0x42, 0x78, 0x26, 0x02, 0x00, 0x00, 0x80},
		{0x05, 0x00, 0xD8, 0x10, 0x9C, 0xD0, 0x40, 0x61, 0x18, 0x00, 0x51, 0x3F, 0xF3, 0x51, 0x30, 0x85, 0x00, 0x10, 0x38, 0x00, 0xE4, 0x10, 0x60, /*0x22, 0x40,*/ 0x08,0x42, 0x64, 0x26, 0x02, 0x00, 0x00, 0x80},
    }
};


/**
 * PHY I2C address.\n
 */
#define PHY_I2C_ADDRESS             0x70
/**
 * MODE_SET_DONE register address.\n
 * For secure configuration of the PHY core, MODE_SET_DONE register is used for an indicator of I2C setting.
 */
#ifdef PHY_TESTCHIP_45NM
#define PHY_REG_MODE_SET_DONE       0x1F
#else
#define PHY_REG_MODE_SET_DONE       0x28
#endif
/**
 * I2C address offset value for control block.\n
 */
#define PHY_CONFIG_START_OFFSET     0x01
#define HDMI_PHY_READY              (1<<0)

/** HDMI device file descriptor */
static int phy_hdmi_fd = -1;

/**
 * @brief HDMI device name.
 * User should change this.
 */
#define HDMI_DEV_NAME   "/dev/hdmi"

/**
 * Initialize HDMI library. Open HDMI device file and audio device file.
 * @return If success, return 1; Otherwise, return 0.
 */
int PHYHDMIOpen(void)
{
    if (phy_hdmi_fd == -1 && (phy_hdmi_fd = open(HDMI_DEV_NAME, O_RDWR)) < 0)
    {
        ALOGE("can not open \"%s\"\n", HDMI_DEV_NAME);
        return 0;
    }

    return 1;
}

/**
 * Finalize HDMI library. Close HDMI device file and audio device file.
 * @return If success, return 1; Otherwise, return 0.
 */
int PHYHDMIClose(void)
{
    int retval = 1;

    if (phy_hdmi_fd != -1)
    {
        if (close(phy_hdmi_fd) < 0)
        {
            ALOGE("can not close \"%s\"\n", HDMI_DEV_NAME);
            retval = 0;
        }
        else
            phy_hdmi_fd = -1;
    }

    return retval;
}


/**
 * This function configures PHY registers via I2C.
 *
 * @param    clk    [in]    Pixel clock value.\n
 *                ex : PIXEL_FREQ_25_200, PIXEL_FREQ_74_250...
 * @param    depth    [in]    Color bit depth.\n
 *                 One of (HDMI_CD_24, HDMI_CD_30, HDMI_CD_36).
 * @return    1=Success, 0=Fail
 */
#if defined(_TCC8930_)
int PHYConfig(const enum PHYFreq freq, const enum ColorDepth depth)
{
    int index;
    int size;
    unsigned char *buffer;
    unsigned char reg;

    // get depth index
    switch (depth)
    {
        case HDMI_CD_24:
            index = 0;
            break;
        case HDMI_CD_30:
            index = 1;
            break;
        case HDMI_CD_36:
            index = 2;
            break;
        default:
            DPRINTF("not available depth arg = %d\n", (int)depth);
            return 0;
    }


    if (!IICOpen())
    {
        DPRINTF("fail to open IIC\n\n");
        return 0;
    }

	    // start to reconfig after that phy_ready goes down
	    reg = 0x00;
	    if (!IICWrite(PHY_I2C_ADDRESS,PHY_REG_MODE_SET_DONE, 1, &reg))
	    {
	        DPRINTF("fail to write reconfig 0x02%x\n",PHY_REG_MODE_SET_DONE);
	        return 0;
	    }

	reg = 0x00;
	if (!IICWrite(PHY_I2C_ADDRESS, PHY_CONFIG_START_OFFSET + 30 , 1, &reg))
	{
		DPRINTF("fail to write reconfig 0x02%x\n",PHY_CONFIG_START_OFFSET);
	    return 0;
	}

#if PHY_DEBUG
    {
        // debugging
        unsigned char tmp;
        if (!IICRead(PHY_I2C_ADDRESS,PHY_CONFIG_START_OFFSET + 30,1,&tmp))
        {
            return 0;
        }

        DPRINTF("0x%02x \n",tmp);
    }
#endif

    size = sizeof(phy_config[freq][index]) /
      sizeof(phy_config[freq][index][0]);
    buffer = (unsigned char *) phy_config[freq][index];

	if (!IICWrite(PHY_I2C_ADDRESS, PHY_CONFIG_START_OFFSET, (size - 1), buffer))
	    {
	   		DPRINTF("fail to write reconfig 0x02%x\n",PHY_CONFIG_START_OFFSET);
	        return 0;
	    }

#if PHY_DEBUG
    {
        // debugging
        unsigned char tmp[31];
        int i = 0;
        if (!IICRead(PHY_I2C_ADDRESS,PHY_CONFIG_START_OFFSET,31,tmp))
        {
            return 0;
        }
        for (;i<31;i++)
        {
             DPRINTF("0x%02x  0x%02x",tmp[i], buffer[i]);
             if ( (i+1) % 8 )
                 DPRINTF(" ");
             else
                 DPRINTF("\n");
        }
        DPRINTF("\n");
    }
#endif

	reg = 0x80;
	if (!IICWrite(PHY_I2C_ADDRESS, PHY_CONFIG_START_OFFSET + 30 , 1, &reg))
	{
		DPRINTF("fail to write reconfig 0x02%x\n",PHY_CONFIG_START_OFFSET);
	    return 0;
	}

#if PHY_DEBUG
    {
        // debugging
        unsigned char tmp;
        if (!IICRead(PHY_I2C_ADDRESS,PHY_CONFIG_START_OFFSET + 30,1,&tmp))
        {
            return 0;
        }

        DPRINTF("0x%02x \n",tmp);
    }
#endif


    if (!IICClose())
    {
        DPRINTF("fail to close IIC\n");
        return 0;
    }
    return 1;
}

#else
int PHYConfig(const enum PHYFreq freq, const enum ColorDepth depth)
{
    int index;

    // get depth index
    switch (depth)
    {
        case HDMI_CD_24:
            index = 0;
            break;
        case HDMI_CD_30:
            index = 1;
            break;
        case HDMI_CD_36:
            index = 2;
            break;
        default:
            DPRINTF("not available depth arg = %d\n", (int)depth);
            return 0;
    }

    if (!PHYHDMIOpen())
    {
        DPRINTF("fail to open HDMI\n\n");
        return 0;
    }

	// set Phy Freq index first.
	if (ioctl(phy_hdmi_fd,HDMI_IOC_SET_PHY_INDEX, &index)) {
		DPRINTF("ioctl(HDMI_IOC_SET_PHY_INDEX) failed! (%d)\n",index);
	}


	// set Phy Freq
	if (ioctl(phy_hdmi_fd,HDMI_IOC_SET_PHY_FREQ, &freq)) {
		DPRINTF("ioctl(HDMI_IOC_SET_PHY_FREQ) failed! (%d)\n",(int)freq);
	}

    if (!PHYHDMIClose())
    {
        DPRINTF("fail to close HDMI\n");
        return 0;
    }
	
    return 1;
}
#endif

