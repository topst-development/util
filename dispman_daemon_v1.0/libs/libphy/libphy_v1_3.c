/****************************************************************************
Copyright (C) 2013 Telechips Inc.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
****************************************************************************/

#include "libphy.h"
#include "libiic/libiic.h"

#include <stdio.h>
#include <string.h>
#include <utils/Log.h>

#define PHY_DEBUG   0
#define LOG_TAG				"LIBPHY: "
#if PHY_DEBUG
#define DPRINTF(args...)    ALOGD(args)
#else
#define DPRINTF(args...)
#endif

/**
 * PHY register setting values for each Pixel clock and Bit depth (8, 10, 12 bit).\n
 * @see  Setting values are came from L6LP_HDMI_v1p3_TX_PHY_RegisterMap_REV0.90.doc document.
 */

static const unsigned char phy_config[][3][31] = {
        //25.200
    {
		{0x05, 0x00, 0xD8, 0x10, 0x1C, 0x30, 0x40, 0x61, 0x10, 0x02, 0x51, 0x5F, 0xF1, 0x51, 0x7F, 0x84, 0x00, 0x10, 0x38, 0x00, 0x08, 0x10, 0xE0, /*0x22, 0x40,*/ 0x00,0x40, 0xF3, 0x26, 0x00, 0x00, 0x00, 0x80},
		{0x05, 0x00, 0xD8, 0x10, 0x1C, 0x30, 0x40, 0x61, 0x10, 0x02, 0x51, 0x9F, 0xF6, 0x51, 0x9E, 0x84, 0x00, 0x32, 0x38, 0x00, 0xB8, 0x10, 0xE0, /*0x22, 0x40,*/ 0x00,0x40, 0xC2, 0x26, 0x00, 0x00, 0x00, 0x80},
		{0x05, 0x00, 0xD8, 0x10, 0x1C, 0x30, 0x40, 0x61, 0x10, 0x02, 0x51, 0xFF, 0xF3, 0x51, 0xBD, 0x84, 0x00, 0x30, 0x38, 0x00, 0xA4, 0x10, 0xE0, /*0x22, 0x40,*/ 0x00,0x40, 0xA2, 0x26, 0x00, 0x00, 0x00, 0x80},

    },
        //25.175
    {
		{0x05, 0x00, 0xD8, 0x10, 0x9C, 0x1E, 0x20, 0x61, 0x50, 0x10, 0x51, 0xFF, 0xF1, 0x51, 0xBD, 0x84, 0x00, 0x10, 0x38, 0x00, 0x08, 0x10, 0xE0, /*0x22, 0x40,*/ 0x00,0x40, 0xF3, 0x26, 0x00, 0x00, 0x00, 0x80},
		{0x05, 0x00, 0xD8, 0x10, 0x9C, 0x2B, 0x40, 0x61, 0x50, 0x10, 0x51, 0x7F, 0xF2, 0x51, 0xEC, 0x84, 0x00, 0x10, 0x38, 0x00, 0xB8, 0x10, 0xE0, /*0x22, 0x40,*/ 0x00,0x40, 0xC2, 0x26, 0x00, 0x00, 0x00, 0x80},
		{0x05, 0x00, 0xD8, 0x10, 0x9C, 0x1E, 0x20, 0x61, 0x10, 0x02, 0x51, 0xFF, 0xF1, 0x51, 0xBD, 0x84, 0x00, 0x10, 0x38, 0x00, 0xA4, 0x10, 0xE0, /*0x22, 0x40,*/ 0x00,0x40, 0xA2, 0x26, 0x00, 0x00, 0x00, 0x80},

    },
        //27.000
    {
		{0x05, 0x00, 0x10, 0x10, 0x9C, 0x01, 0xDB, 0x61, 0x10, 0x02, 0x51, 0xDF, 0xF2, 0x51, 0x87, 0x84, 0x00, 0x30, 0x38, 0x00, 0x08, 0x10, 0xE0, /*0x22, 0x40,*/ 0x00,0x40, 0xE3, 0x26, 0x00, 0x00, 0x00, 0x80},
		{0x05, 0x00, 0xD8, 0x10, 0x9E, 0x2D, 0xDB, 0x61, 0x10, 0x02, 0x51, 0xEF, 0xF1, 0x51, 0xA9, 0x84, 0x00, 0x10, 0x38, 0x00, 0xB8, 0x10, 0xE0, /*0x22, 0x40,*/ 0x00,0x40, 0xB5, 0x26, 0x00, 0x00, 0x00, 0x80},
		{0x05, 0x00, 0xD8, 0x10, 0x9E, 0xD2, 0x5B, 0x61, 0x10, 0x02, 0x51, 0x2F, 0xF2, 0x51, 0xCB, 0x84, 0x00, 0x10, 0x38, 0x00, 0xA4, 0x10, 0xE0, /*0x22, 0x40,*/ 0x00,0x40, 0x97, 0x26, 0x00, 0x00, 0x00, 0x80},
    },
        //27.027
    {
		{0x05, 0x00, 0xD4, 0x10, 0x9C, 0x09, 0x64, 0x61, 0x10, 0x02, 0x51, 0xDF, 0xF2, 0x51, 0x87, 0x84, 0x00, 0x30, 0x38, 0x00, 0x08, 0x10, 0xE0, /*0x22, 0x40,*/ 0x00,0x40, 0xE2, 0x26, 0x00, 0x00, 0x00, 0x80},
		{0x05, 0x00, 0xD4, 0x10, 0x9C, 0x31, 0x50, 0x61, 0x10, 0x02, 0x51, 0x8F, 0xF3, 0x51, 0xA9, 0x84, 0x00, 0x30, 0x38, 0x00, 0xB8, 0x10, 0xE0, /*0x22, 0x40,*/ 0x00,0x40, 0xB5, 0x26, 0x00, 0x00, 0x00, 0x80},
		{0x05, 0x00, 0x10, 0x10, 0x9C, 0x1B, 0x64, 0x61, 0x10, 0x02, 0x51, 0x7F, 0xF8, 0x51, 0xCB, 0x84, 0x00, 0x32, 0x38, 0x00, 0xA4, 0x10, 0xE0, /*0x22, 0x40,*/ 0x00,0x40, 0x97, 0x26, 0x00, 0x00, 0x00, 0x80},
    },
        //54.000
    {
		{0x05, 0x00, 0x10, 0x10, 0x9C, 0x01, 0xDB, 0x61, 0x10, 0x01, 0x51, 0xDF, 0xF2, 0x51, 0x87, 0x84, 0x00, 0x30, 0x38, 0x00, 0x08, 0x10, 0xE0, /*0x22, 0x40,*/ 0x00,0x40, 0xE3, 0x26, 0x01, 0x00, 0x00, 0x80},
		{0x05, 0x00, 0xD8, 0x10, 0x9C, 0x2D, 0xDB, 0x61, 0x10, 0x01, 0x51, 0xCF, 0xF1, 0x51, 0xA9, 0x84, 0x00, 0x10, 0x38, 0x00, 0xF8, 0x10, 0xE0, /*0x22, 0x40,*/ 0x00,0x40, 0xB5, 0x26, 0x01, 0x00, 0x00, 0x80},
		{0x05, 0x00, 0xD8, 0x10, 0x9C, 0xD2, 0x5B, 0x61, 0x10, 0x01, 0x51, 0x2F, 0xF2, 0x51, 0xCB, 0x84, 0x00, 0x10, 0x38, 0x00, 0xE4, 0x10, 0xE0, /*0x22, 0x40,*/ 0x00,0x40, 0x97, 0x26, 0x01, 0x00, 0x00, 0x80},
    },
        //54.054
    {
		{0x05, 0x00, 0xD4, 0x10, 0x9C, 0x09, 0x64, 0x61, 0x10, 0x01, 0x51, 0xDF, 0xF2, 0x51, 0x87, 0x84, 0x00, 0x30, 0x38, 0x00, 0x08, 0x10, 0xE0, /*0x22, 0x40,*/ 0x00,0x40, 0xE2, 0x26, 0x01, 0x00, 0x00, 0x80},
		{0x05, 0x00, 0xD4, 0x10, 0x9C, 0x31, 0x50, 0x61, 0x10, 0x01, 0x51, 0x8F, 0xF3, 0x51, 0xA9, 0x84, 0x00, 0x30, 0x38, 0x00, 0xF8, 0x10, 0xE0, /*0x22, 0x40,*/ 0x00,0x40, 0xB5, 0x26, 0x01, 0x00, 0x00, 0x80},
		{0x05, 0x00, 0x10, 0x10, 0x9C, 0x1B, 0x64, 0x61, 0x10, 0x01, 0x51, 0x7F, 0xF8, 0x51, 0xCB, 0x84, 0x00, 0x32, 0x38, 0x00, 0xE4, 0x10, 0xE0, /*0x22, 0x40,*/ 0x00,0x40, 0x97, 0x26, 0x01, 0x00, 0x00, 0x80},
    },
        //74.250
    {
		{0x05, 0x00, 0xD8, 0x10, 0x9C, 0xE9, 0xDC, 0x61, 0x10, 0x01, 0x51, 0xFF, 0xF1, 0x51, 0xBA, 0x84, 0x00, 0x10, 0x38, 0x00, 0x08, 0x10, 0xE0, /*0x22, 0x40,*/ 0x00,0x40, 0xA4, 0x26, 0x01, 0x00, 0x00, 0x80},
		{0x05, 0x00, 0xD8, 0x10, 0x9C, 0x37, 0xD0, 0x61, 0x10, 0x01, 0x51, 0xDF, 0xF4, 0x51, 0xE8, 0x84, 0x00, 0x30, 0x38, 0x00, 0xF8, 0x10, 0xE0, /*0x22, 0x40,*/ 0x00,0x40, 0x83, 0x26, 0x01, 0x00, 0x00, 0x80},
		{0x05, 0x00, 0xD8, 0x10, 0x9C, 0xE2, 0xD0, 0x61, 0x10, 0x01, 0x51, 0xDF, 0xF5, 0x51, 0x16, 0x85, 0x00, 0x30, 0x38, 0x00, 0xE4, 0x10, 0xE0, /*0x22, 0x40,*/ 0x00,0x40, 0xDC, 0x26, 0x02, 0x00, 0x00, 0x80},
    },
        //74.176
    {
		{0x05, 0x00, 0xD4, 0x10, 0x9C, 0xBC, 0xDB, 0x61, 0x10, 0x01, 0x51, 0xEF, 0xF3, 0x51, 0xB9, 0x84, 0x00, 0x30, 0x38, 0x00, 0x08, 0x10, 0xE0, /*0x22, 0x40,*/ 0x00,0x40, 0xA5, 0x26, 0x01, 0x00, 0x00, 0x80},
		{0x05, 0x00, 0xD4, 0x10, 0x9C, 0xAB, 0xDB, 0x61, 0x10, 0x01, 0x51, 0xBF, 0xF9, 0x51, 0xE8, 0x84, 0x00, 0x32, 0x38, 0x00, 0xF8, 0x10, 0xE0, /*0x22, 0x40,*/ 0x00,0x40, 0x84, 0x26, 0x01, 0x00, 0x00, 0x80},
		{0x05, 0x00, 0xD8, 0x10, 0x9C, 0xCD, 0xDB, 0x61, 0x10, 0x01, 0x51, 0xDF, 0xF5, 0x51, 0x16, 0x84, 0x00, 0x30, 0x38, 0x00, 0xE4, 0x10, 0xE0, /*0x22, 0x40,*/ 0x00,0x40, 0xDC, 0x26, 0x02, 0x00, 0x00, 0x80},
    },
        //148.500
    {
		{0x05, 0x00, 0xD8, 0x10, 0x9C, 0xE9, 0xDC, 0x61, 0x18, 0x00, 0x51, 0xFF, 0xF1, 0x51, 0xBA, 0x84, 0x00, 0x10, 0x38, 0x00, 0x08, 0x10, 0xE0, /*0x22, 0x40,*/ 0x00,0x40, 0xA4, 0x26, 0x02, 0x00, 0x00, 0x80},
		{0x05, 0x00, 0xD8, 0x10, 0x9C, 0x37, 0xD0, 0x61, 0x18, 0x00, 0x51, 0xDF, 0xF4, 0x51, 0xE8, 0x84, 0x00, 0x30, 0x38, 0x00, 0xF8, 0x10, 0x60, /*0x22, 0x40,*/ 0x08,0x42, 0x83, 0x26, 0x02, 0x00, 0x00, 0x80},
		{0x05, 0x00, 0xD8, 0x10, 0x9C, 0xE2, 0xD0, 0x61, 0x18, 0x00, 0x51, 0xDF, 0xF5, 0x51, 0x16, 0x85, 0x00, 0x30, 0x38, 0x00, 0xE4, 0x10, 0x60, /*0x22, 0x40,*/ 0x08,0x42, 0x6D, 0x26, 0x02, 0x00, 0x00, 0x80},
    },
        //148.352
    {
		{0x05, 0x00, 0xD4, 0x10, 0x9C, 0xBC, 0xDB, 0x61, 0x18, 0x00, 0x51, 0xEF, 0xF3, 0x51, 0xB9, 0x84, 0x00, 0x30, 0x38, 0x00, 0x08, 0x10, 0xE0, /*0x22, 0x40,*/ 0x00,0x40, 0xA5, 0x26, 0x02, 0x00, 0x00, 0x80},
		{0x05, 0x00, 0xD4, 0x10, 0x9C, 0xAB, 0xDB, 0x61, 0x18, 0x00, 0x51, 0xBF, 0xF9, 0x51, 0xE8, 0x84, 0x00, 0x32, 0x38, 0x00, 0xF8, 0x10, 0xE0, /*0x22, 0x40,*/ 0x08,0x42, 0x84, 0x26, 0x02, 0x00, 0x00, 0x80},
		{0x05, 0x00, 0xD8, 0x10, 0x9C, 0xCD, 0xDB, 0x61, 0x18, 0x00, 0x51, 0xDF, 0xF5, 0x51, 0x16, 0x85, 0x00, 0x30, 0x38, 0x00, 0xE4, 0x10, 0xE0, /*0x22, 0x40,*/ 0x08,0x42, 0x6D, 0x26, 0x02, 0x00, 0x00, 0x80},
    },
        //108.108
    {
		{0x05, 0x00, 0xD4, 0x10, 0x9C, 0x09, 0x64, 0x61, 0x18, 0x00, 0x51, 0xDF, 0xF2, 0x51, 0x87, 0x84, 0x00, 0x30, 0x38, 0x00, 0x08, 0x10, 0xE0, /*0x22, 0x40,*/ 0x00,0x40, 0xE2, 0x26, 0x02, 0x00, 0x00, 0x80},
		{0x05, 0x00, 0xD4, 0x10, 0x9C, 0x31, 0x50, 0x61, 0x18, 0x00, 0x51, 0x8F, 0xF3, 0x51, 0xA9, 0x84, 0x00, 0x30, 0x38, 0x00, 0xF8, 0x10, 0xE0, /*0x22, 0x40,*/ 0x00,0x40, 0xB5, 0x26, 0x02, 0x00, 0x00, 0x80},
		{0x05, 0x00, 0x10, 0x10, 0x9C, 0x1B, 0x64, 0x61, 0x18, 0x00, 0x51, 0x7F, 0xF8, 0x51, 0xCB, 0x84, 0x00, 0x32, 0x38, 0x00, 0xE4, 0x10, 0xE0, /*0x22, 0x40,*/ 0x00,0x40, 0x97, 0x26, 0x02, 0x00, 0x00, 0x80},
    },
        //72.000
    {
		{0x05, 0x00, 0xD8, 0x10, 0x1C, 0x30, 0x40, 0x61, 0x10, 0x01, 0x51, 0xEF, 0xF1, 0x51, 0xB4, 0x84, 0x00, 0x10, 0x38, 0x00, 0x08, 0x10, 0xE0, /*0x22, 0x40,*/ 0x00,0x40, 0xAA, 0x26, 0x01, 0x00, 0x00, 0x80},
		{0x05, 0x00, 0xD8, 0x10, 0x1C, 0x30, 0x40, 0x61, 0x10, 0x01, 0x51, 0xBF, 0xF4, 0x51, 0xE1, 0x84, 0x00, 0x30, 0x38, 0x00, 0xF8, 0x10, 0xE0, /*0x22, 0x40,*/ 0x00,0x40, 0x88, 0x26, 0x01, 0x00, 0x00, 0x80},
		{0x05, 0x00, 0xD8, 0x10, 0x1C, 0x30, 0x40, 0x61, 0x18, 0x00, 0x51, 0xDF, 0xF2, 0x51, 0x87, 0x84, 0x00, 0x30, 0x38, 0x00, 0xE4, 0x10, 0xE0, /*0x22, 0x40,*/ 0x00,0x40, 0xE3, 0x26, 0x02, 0x00, 0x00, 0x80},
    },
        //25.000
    {
		{0x05, 0x00, 0xD8, 0x10, 0x9C, 0x20, 0x40, 0x61, 0x50, 0x10, 0x51, 0xFF, 0xF1, 0x51, 0xBC, 0x84, 0x00, 0x10, 0x38, 0x00, 0x08, 0x10, 0xE0, /*0x22, 0x40,*/ 0x00,0x40, 0xF5, 0x26, 0x00, 0x00, 0x00, 0x80},
		{0x05, 0x00, 0xD8, 0x10, 0x9C, 0x08, 0x40, 0x61, 0x50, 0x10, 0x51, 0x7F, 0xF2, 0x51, 0xEA, 0x84, 0x00, 0x10, 0x38, 0x00, 0xB8, 0x10, 0xE0, /*0x22, 0x40,*/ 0x00,0x40, 0xC4, 0x26, 0x00, 0x00, 0x00, 0x80},
		{0x05, 0x00, 0xD8, 0x10, 0x9C, 0x20, 0x40, 0x61, 0x10, 0x02, 0x51, 0xFF, 0xF1, 0x51, 0xBC, 0x84, 0x00, 0x10, 0x38, 0x00, 0xA4, 0x10, 0xE0, /*0x22, 0x40,*/ 0x00,0x40, 0xA3, 0x26, 0x00, 0x00, 0x00, 0x80},
    },
        //65.000
    {
		{0x05, 0x00, 0xD8, 0x10, 0x9C, 0x02, 0x0C, 0x61, 0x10, 0x01, 0x51, 0xBF, 0xF1, 0x51, 0xA3, 0x84, 0x00, 0x10, 0x38, 0x00, 0x08, 0x10, 0xE0, /*0x22, 0x40,*/ 0x00,0x40, 0xBC, 0x26, 0x01, 0x00, 0x00, 0x80},
		{0x05, 0x00, 0xD8, 0x10, 0x9C, 0xF2, 0x30, 0x61, 0x10, 0x01, 0x51, 0x1F, 0xF2, 0x51, 0xCB, 0x84, 0x00, 0x10, 0x38, 0x00, 0xF8, 0x10, 0xE0, /*0x22, 0x40,*/ 0x00,0x40, 0x96, 0x26, 0x01, 0x00, 0x00, 0x80},
		{0x05, 0x00, 0xD8, 0x10, 0x9C, 0xD0, 0x40, 0x61, 0x10, 0x01, 0x51, 0x9F, 0xF2, 0x51, 0xF4, 0x84, 0x00, 0x10, 0x38, 0x00, 0xE4, 0x10, 0xE0, /*0x22, 0x40,*/ 0x00,0x40, 0x7D, 0x26, 0x01, 0x00, 0x00, 0x80},
    },
        //108.000
    {
		{0x05, 0x00, 0xD8, 0x10, 0x1C, 0x30, 0x40, 0x61, 0x18, 0x00, 0x51, 0xDF, 0xF2, 0x51, 0x87, 0x84, 0x00, 0x30, 0x38, 0x00, 0x08, 0x10, 0xE0, /*0x22, 0x40,*/ 0x00,0x40, 0xE3, 0x26, 0x02, 0x00, 0x00, 0x80},
		{0x05, 0x00, 0xD8, 0x10, 0x9C, 0x02, 0x08, 0x61, 0x18, 0x00, 0x51, 0xCF, 0xF1, 0x51, 0xA9, 0x84, 0x00, 0x10, 0x38, 0x00, 0xF8, 0x10, 0xE0, /*0x22, 0x40,*/ 0x00,0x40, 0xB5, 0x26, 0x02, 0x00, 0x00, 0x80},
		{0x05, 0x00, 0xD8, 0x10, 0x9C, 0xFC, 0x08, 0x61, 0x18, 0x00, 0x51, 0x2F, 0xF2, 0x51, 0xCB, 0x84, 0x00, 0x10, 0x38, 0x00, 0xE4, 0x10, 0xE0, /*0x22, 0x40,*/ 0x00,0x40, 0x97, 0x26, 0x02, 0x00, 0x00, 0x80},
    },
        //162.000
    {
		{0x05, 0x00, 0xD8, 0x10, 0x1C, 0x30, 0x40, 0x61, 0x18, 0x00, 0x51, 0x7F, 0xF8, 0x51, 0xCB, 0x84, 0x00, 0x32, 0x38, 0x00, 0x08, 0x10, 0xE0, /*0x22, 0x40,*/ 0x00,0x40, 0x97, 0x26, 0x02, 0x00, 0x00, 0x80},
		{0x05, 0x00, 0xD8, 0x10, 0x9C, 0x18, 0x40, 0x61, 0x18, 0x00, 0x51, 0xAF, 0xF2, 0x51, 0xFD, 0x84, 0x00, 0x10, 0x38, 0x00, 0xF8, 0x10, 0x60, /*0x22, 0x40,*/ 0x08,0x42, 0x78, 0x26, 0x02, 0x00, 0x00, 0x80},
		{0x05, 0x00, 0xD8, 0x10, 0x9C, 0xD0, 0x40, 0x61, 0x18, 0x00, 0x51, 0x3F, 0xF3, 0x51, 0x30, 0x85, 0x00, 0x10, 0x38, 0x00, 0xE4, 0x10, 0x60, /*0x22, 0x40,*/ 0x08,0x42, 0x64, 0x26, 0x02, 0x00, 0x00, 0x80},
    }
};

/**
 * PHY I2C address.\n
 */
#define PHY_I2C_ADDRESS             0x70
/**
 * MODE_SET_DONE register address.\n
 * For secure configuration of the PHY core, MODE_SET_DONE register is used for an indicator of I2C setting.
 */
#ifdef PHY_TESTCHIP_45NM
#define PHY_REG_MODE_SET_DONE       0x1F
#else
#define PHY_REG_MODE_SET_DONE       0x28
#endif
/**
 * I2C address offset value for control block.\n
 */
#define PHY_CONFIG_START_OFFSET     0x01
#define HDMI_PHY_READY              (1<<0)

/**
 * This function configures PHY registers via I2C.
 *
 * @param    clk    [in]    Pixel clock value.\n
 *                ex : PIXEL_FREQ_25_200, PIXEL_FREQ_74_250...
 * @param    depth    [in]    Color bit depth.\n
 *                 One of (HDMI_CD_24, HDMI_CD_30, HDMI_CD_36).
 * @return    1=Success, 0=Fail
 */
int PHYConfig(const enum PixelFreq clk, const enum ColorDepth depth)
{
    int index, freq;
    int size;
    unsigned char *buffer;
    unsigned char reg;

    // get depth index
    switch (depth)
    {
        case HDMI_CD_24:
            index = 0;
            break;
        case HDMI_CD_30:
            index = 1;
            break;
        case HDMI_CD_36:
            index = 2;
            break;
        default:
            DPRINTF("not available depth arg = %d\n", (int)depth);
            return 0;
    }

    // get clk freq index
    switch (clk)
    {
        case PIXEL_FREQ_25_200 :
            freq = 0;
            break;
        case PIXEL_FREQ_25_175 :
            freq = 1;
            break;
        case PIXEL_FREQ_27 :
            freq = 2;
            break;
        case PIXEL_FREQ_27_027 :
            freq = 3;
            break;
        case PIXEL_FREQ_54 :
            freq = 4;
            break;
        case PIXEL_FREQ_54_054 :
            freq = 5;
            break;
        case PIXEL_FREQ_74_250 :
            freq = 6;
            break;
        case PIXEL_FREQ_74_176 :
            freq = 7;
            break;
        case PIXEL_FREQ_148_500 :
            freq = 8;
            break;
        case PIXEL_FREQ_148_352 :
            freq = 9;
            break;
        case PIXEL_FREQ_108_108 :
            freq = 10;
            break;
        case PIXEL_FREQ_72 :
            freq = 11;
            break;
        case PIXEL_FREQ_25 :
            freq = 12;
            break;
        case PIXEL_FREQ_65 :
            freq = 13;
            break;
        case PIXEL_FREQ_108 :
            freq = 14;
            break;
        case PIXEL_FREQ_162 :
            freq = 15;
            break;
        case PIXEL_FREQ_84_75:
            freq = 16;
            break;
        case PIXEL_FREQ_37_293:
            freq = 17;
            break;
        default:
            DPRINTF("not availlable clk arg = %d\n",(int)clk);
            return 0;
    }

    if (!IICOpen())
    {
        DPRINTF("fail to open IIC\n\n");
        return 0;
    }

#ifdef PHY_TESTCHIP_45NM
    {
        unsigned char mux_mode;
        unsigned char tmp[32];

//TODO: 31 or 32???
        // copy the vector
        memcpy((void*)tmp,(const void*)phy_config[freq][index],32);

        // set MUX for not stopping TMDS clk
        reg = 0x18;
        if (!IICWrite(PHY_I2C_ADDRESS, 0x09, 1, &reg))
        {
            DPRINTF("fail to write reconfig MUX\n");
            return 0;
        }

        // change MUX value for not stopping TMDS clk.
        mux_mode = tmp[8];
        if (mux_mode == 0x10)
        {
            tmp[8] = 0x18;
        }

        size = sizeof(tmp);
        buffer = (unsigned char *) tmp;

        // setting with changed value
        if (!IICWrite(PHY_I2C_ADDRESS, PHY_CONFIG_START_OFFSET, size, buffer))
        {
            DPRINTF("fail IICWrite(PHY_I2C_ADDRESS, PHY_CONF \n");

            return 0;
        }

        // set mux_mode as it is
        if (mux_mode == 0x10)
        {
            if (!IICWrite(PHY_I2C_ADDRESS,0x09, 1, &mux_mode))
            {
                DPRINTF("fail to write reconfig MUX\n");
                return 0;
            }
        }
    }

#if PHY_DEBUG
    {
        // debugging
        unsigned char tmp[31];
        int i = 0;
        if (!IICRead(PHY_I2C_ADDRESS,PHY_CONFIG_START_OFFSET,31,tmp))
        {
            return 0;
        }
        for (;i<31;i++)
        {
             DPRINTF("0x%02x",tmp[i]);
             if ( (i+1) % 8 )
                 DPRINTF(" ");
             else
                 DPRINTF("\n");
        }
        DPRINTF("\n");
    }
#endif

#else
    // start to reconfig after that phy_ready goes down
    reg = 0x00;
    if (!IICWrite(PHY_I2C_ADDRESS,PHY_REG_MODE_SET_DONE, 1, &reg))
    {
        DPRINTF("fail to write reconfig 0x02%x\n",PHY_REG_MODE_SET_DONE);
        return 0;
    }

    size = sizeof(phy_config[freq][index]) /
      sizeof(phy_config[freq][index][0]);
    buffer = (unsigned char *) phy_config[freq][index];

    if (!IICWrite(PHY_I2C_ADDRESS, PHY_CONFIG_START_OFFSET, size, buffer))
    {
   		DPRINTF("fail to write reconfig 0x02%x\n",PHY_CONFIG_START_OFFSET);
        return 0;
    }

#if PHY_DEBUG
    {
        // debugging
        unsigned char tmp[31];
        int i = 0;
        if (!IICRead(PHY_I2C_ADDRESS,PHY_CONFIG_START_OFFSET,31,tmp))
        {
            return 0;
        }
        for (;i<31;i++)
        {
             DPRINTF("0x%02x  0x%02x",tmp[i], buffer[i]);
             if ( (i+1) % 8 )
                 DPRINTF(" ");
             else
                 DPRINTF("\n");
        }
        DPRINTF("\n");
    }
#endif
#endif

    if (!IICClose())
    {
        DPRINTF("fail to close IIC\n");
        return 0;
    }
    return 1;
}

int PHYPowerDown(void)
{
    unsigned char reg, tmp;
        DPRINTF("PHYPowerDown IIC\n");

    if (!IICOpen())    {
        DPRINTF("fail to open IIC\n\n");
        return 0;
    }


    // start to reconfig after that phy_ready goes down
    reg = 0x00;
    if (!IICWrite(PHY_I2C_ADDRESS,PHY_REG_MODE_SET_DONE, 1, &reg))
    {
        DPRINTF("fail to write reconfig 0x02%x\n",PHY_REG_MODE_SET_DONE);
        return 0;
    }
	
   IICRead(PHY_I2C_ADDRESS,PHY_REG_MODE_SET_DONE,1,&tmp);
    DPRINTF("PHY_I2C_ADDRESS 0x%x 0x%x\n",PHY_REG_MODE_SET_DONE, tmp);

   //bias power down & sigma delta modulator clock generator power down
    reg = 0xA0;
    if (!IICWrite(PHY_I2C_ADDRESS,0x01, 1, &reg))
    {
        DPRINTF("fail to write reconfig 0x02%x\n",0x01);
        return 0;
    }
	IICRead(PHY_I2C_ADDRESS,0x01,1,&tmp);
	DPRINTF("PHY_I2C_ADDRESS 0x%x 0x%x\n",0x01, tmp);

   //bias power down & sigma delta modulator clock generator power down
    reg = 0x20;
    if (!IICWrite(PHY_I2C_ADDRESS,0x05, 1, &reg))
    {
        DPRINTF("fail to write reconfig 0x02%x\n",0x05);
        return 0;
    }
	IICRead(PHY_I2C_ADDRESS,0x05,1,&tmp);
	DPRINTF("PHY_I2C_ADDRESS 0x%x 0x%x\n",0x05, tmp);

   //bias power down & sigma delta modulator clock generator power down
    reg = 0x03;
    if (!IICWrite(PHY_I2C_ADDRESS,0x17, 1, &reg))
    {
        DPRINTF("fail to write reconfig 0x02%x\n",0x17);
        return 0;
    }
   IICRead(PHY_I2C_ADDRESS,0x17,1,&tmp);
   DPRINTF("PHY_I2C_ADDRESS 0x%x 0x%x\n",0x17, tmp);


    if (!IICClose())
    {
        DPRINTF("fail to close IIC\n");
        return 0;
    }
    return 1;
}

